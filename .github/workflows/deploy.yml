name: Deploy to Production
on:
    push:
        branches: [main]
    workflow_dispatch: # Allow manual deployment
jobs:
    deploy:
        name: Deploy to Server
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
            - name: Rsync files to server
              run: |
                  rsync -avz \
                    -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
                    ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/weightloss_watch/
            - name: Deploy application on server
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      export NVM_DIR="$HOME/.nvm"
                      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                      echo "USE NODE 25"
                      nvm use 25

                      echo "MOVE TO WEB DIR"
                      cd /var/www/weightloss_watch

                      echo "BUILD DEPENDENCIES"
                      npm ci

                      echo "GENERATE PRISMA CLIENT"
                      npx prisma generate

                      echo "DEPLOY PRISMA MIGRATIONS"
                      npx prisma migrate deploy

                      echo "BUILD APPLICATION"
                      npm run build

                      echo "MAKE UPDLOAD DIRECTORIES"
                      mkdir -p public/uploads/avatars public/uploads/progress
                      chmod 775 public/uploads public/uploads/avatars public/uploads/progress
                      mkdir -p logs

                      echo "RESTART NODE"
                      .npm-global/bin/pm2 restart wlt || .npm-global/bin/pm2 start ecosystem.config.js
                      .npm-global/bin/pm2 save
            - name: Cleanup SSH
              if: always()
              run: rm -f ~/.ssh/deploy_key
