<div class="max-w-2xl mx-auto">
	<div class="bg-white rounded-lg shadow p-6">
		<h1 class="text-2xl font-bold text-slate-800 mb-6">Edit Profile</h1>

		<% if (success) { %>
			<div class="mb-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg">
				<%= success %>
			</div>
		<% } %>

		<% if (errors && errors.length > 0) { %>
			<div class="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
				<ul class="list-disc list-inside">
					<% errors.forEach(error => { %>
						<li><%= error.msg %></li>
					<% }); %>
				</ul>
			</div>
		<% } %>

		<form action="/profile/edit" method="POST" enctype="multipart/form-data" class="space-y-6">
			<!-- Basic Information -->
			<div class="border-b border-gray-200 pb-6">
				<h2 class="text-lg font-semibold text-slate-700 mb-4">Basic Information</h2>

				<!-- Profile Picture -->
				<div class="mb-6">
					<label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
					<div class="flex items-center gap-4">
						<div class="relative">
							<% if (user.avatarUrl) { %>
								<img id="avatarPreview" src="<%= user.avatarUrl %>" alt="Profile" class="w-24 h-24 rounded-full object-cover border-2 border-gray-300">
							<% } else { %>
								<div id="avatarPreview" class="w-24 h-24 rounded-full bg-blue-500 flex items-center justify-center text-white text-3xl font-bold border-2 border-gray-300">
									<%= (user.displayName || user.username).charAt(0).toUpperCase() %>
								</div>
							<% } %>
						</div>
						<div class="flex-1">
							<input type="file" id="avatar" name="avatar" accept="image/*"
								class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
								onchange="previewAvatar(event)">
							<p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF or WebP. Max 5MB.</p>
						</div>
					</div>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
						<input type="text" id="username" value="<%= user.username %>" disabled
							class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed">
						<p class="text-xs text-gray-500 mt-1">Username cannot be changed</p>
					</div>

					<div>
						<label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
						<input type="email" id="email" value="<%= user.email %>" disabled
							class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed">
						<p class="text-xs text-gray-500 mt-1">Email cannot be changed here</p>
					</div>

					<div>
						<label for="displayName" class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
						<input type="text" id="displayName" name="displayName" value="<%= user.displayName || '' %>"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>

					<div>
						<label for="dateOfBirth" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
						<input type="date" id="dateOfBirth" name="dateOfBirth"
							value="<%= user.dateOfBirth && !isNaN(new Date(user.dateOfBirth).getTime()) ? new Date(user.dateOfBirth).toISOString().split('T')[0] : '' %>"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
				</div>

				<div class="mt-4">
					<label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
					<textarea id="bio" name="bio" rows="3" maxlength="500"
						class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"><%= user.bio || '' %></textarea>
					<p class="text-xs text-gray-500 mt-1">Max 500 characters</p>
				</div>
			</div>

			<!-- Physical Information -->
			<div class="border-b border-gray-200 pb-6">
				<h2 class="text-lg font-semibold text-slate-700 mb-4">Physical Information</h2>
				
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
						<select id="gender" name="gender"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="">Select gender...</option>
							<% genders.forEach(g => { %>
								<option value="<%= g.value %>" <%= user.gender === g.value ? 'selected' : '' %>><%= g.label %></option>
							<% }); %>
						</select>
					</div>

					<div>
						<label for="activityLevel" class="block text-sm font-medium text-gray-700 mb-1">Activity Level</label>
						<select id="activityLevel" name="activityLevel"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="">Select activity level...</option>
							<% activityLevels.forEach(a => { %>
								<option value="<%= a.value %>" <%= user.activityLevel === a.value ? 'selected' : '' %>><%= a.label %></option>
							<% }); %>
						</select>
					</div>

					<div>
						<label for="unitSystem" class="block text-sm font-medium text-gray-700 mb-1">Unit System</label>
						<select id="unitSystem" name="unitSystem" required
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<% unitSystems.forEach(u => { %>
								<option value="<%= u.value %>" <%= user.unitSystem === u.value ? 'selected' : '' %>><%= u.label %></option>
							<% }); %>
						</select>
					</div>

					<div>
						<label for="height" class="block text-sm font-medium text-gray-700 mb-1">
							Height (<span id="heightUnit"><%= user.unitSystem === 'IMPERIAL' ? 'inches' : 'cm' %></span>)
						</label>
						<input type="number" id="height" name="height" step="0.1" min="0" max="300"
							value="<%= user.height || '' %>"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
				</div>
			</div>

			<!-- Weight Goals -->
			<div class="border-b border-gray-200 pb-6">
				<h2 class="text-lg font-semibold text-slate-700 mb-4">Weight Goals</h2>
				
				<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
					<div>
						<label for="currentWeight" class="block text-sm font-medium text-gray-700 mb-1">
							Current Weight (<span id="weightUnit"><%= user.unitSystem === 'IMPERIAL' ? 'lbs' : 'kg' %></span>)
						</label>
						<input type="number" id="currentWeight" name="currentWeight" step="0.1" min="0" max="1000"
							value="<%= user.currentWeight || '' %>"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>

					<div>
						<label for="goalWeight" class="block text-sm font-medium text-gray-700 mb-1">
							Goal Weight (<span id="goalWeightUnit"><%= user.unitSystem === 'IMPERIAL' ? 'lbs' : 'kg' %></span>)
						</label>
						<input type="number" id="goalWeight" name="goalWeight" step="0.1" min="0" max="1000"
							value="<%= user.goalWeight || '' %>"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>

					<div>
						<label for="targetDate" class="block text-sm font-medium text-gray-700 mb-1">Target Date</label>
						<input type="date" id="targetDate" name="targetDate"
							value="<%= user.targetDate && !isNaN(new Date(user.targetDate).getTime()) ? new Date(user.targetDate).toISOString().split('T')[0] : '' %>"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
				</div>
			</div>

			<!-- Appearance Settings -->
			<div class="border-b border-gray-200 pb-6">
				<h2 class="text-lg font-semibold text-slate-700 mb-4">Appearance</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label for="theme" class="block text-sm font-medium text-gray-700 mb-1">Theme</label>
						<select id="theme" name="theme"
							class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="light" <%= user.theme === 'light' ? 'selected' : '' %>>Light</option>
							<option value="dark" <%= user.theme === 'dark' ? 'selected' : '' %>>Dark</option>
						</select>
					</div>
				</div>
			</div>

			<!-- Privacy Settings -->
			<div class="pb-6">
				<h2 class="text-lg font-semibold text-slate-700 mb-4">Privacy Settings</h2>
				
				<div class="space-y-3">
					<label class="flex items-center gap-3">
						<input type="checkbox" name="profilePublic" value="true" <%= user.profilePublic ? 'checked' : '' %>
							class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
						<span class="text-gray-700">Make my profile public</span>
					</label>

					<label class="flex items-center gap-3">
						<input type="checkbox" name="weightVisible" value="true" <%= user.weightVisible ? 'checked' : '' %>
							class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
						<span class="text-gray-700">Show my weight to team members</span>
					</label>
				</div>
			</div>

			<!-- Submit Button -->
			<div class="flex justify-end gap-4">
				<a href="/dashboard" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
					Cancel
				</a>
				<button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
					Save Changes
				</button>
			</div>
		</form>
	</div>
</div>

<script>
	// Update unit labels when unit system changes
	document.getElementById('unitSystem').addEventListener('change', function() {
		const isImperial = this.value === 'IMPERIAL';
		document.getElementById('heightUnit').textContent = isImperial ? 'inches' : 'cm';
		document.getElementById('weightUnit').textContent = isImperial ? 'lbs' : 'kg';
		document.getElementById('goalWeightUnit').textContent = isImperial ? 'lbs' : 'kg';
	});

	// Preview avatar before upload
	function previewAvatar(event) {
		const file = event.target.files[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = function(e) {
				const preview = document.getElementById('avatarPreview');
				// Replace the div/img with an img element
				preview.outerHTML = '<img id="avatarPreview" src="' + e.target.result + '" alt="Profile Preview" class="w-24 h-24 rounded-full object-cover border-2 border-gray-300">';
			};
			reader.readAsDataURL(file);
		}
	}
</script>
